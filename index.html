<!DOCTYPE html>
<hmtl lang="en">
<head>
	<title>Minesweeper Canvas</title>
	<meta charset="utf-8">
	
	<link rel="stylesheet" media="screen" type="text/css" href="css/styles.css" />
	<link href='http://fonts.googleapis.com/css?family=Open+Sans:300,600,700' rel='stylesheet' type='text/css'>
	
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.6.2/jquery.min.js" type="text/javascript"></script>
	
	<script type="text/javascript">
	
	/* =========================================== */
	// --- Global & Default Variables --- 
	/* =========================================== */
	
	var globals = {
		firstClick: true,
		gameover: false,
		canvas: '',
		context: '',
		totalMines: 0,
		totalFlags: 0,
		elapsedTime: 0,
		clock: '',
		restart: '',
		mineMap: new Array(20),
		flagMap: new Array(20),
		revealedMap: new Array(20)
	},
	
	defaults = {
		difficulty: 0,
		celSize: 20,
		width: 400,
		height: 400,
		background: 'white',
		font: '13pt Arial',
		celColor: '#ccc',
		celStroke: 'white',
		celRadius: 5,
		mineImg: 'http://images4.wikia.nocookie.net/__cb20100714194517/sims/images/3/31/Moodlet_icon_amused_fun.png',
		flagImg: 'http://www.mricons.com/store/png/116766_34244_32_antivirus_protection_red_shield_icon.png'
	},
	
	containers = {
		// In core.init(), we add containers.
	};
	
	/* =========================================== */
	// --- Core Functions ---
	/* =========================================== */
	
	var core = {
		
		/* ------------------------------------------- */
		// -- Initiate function
		// -- Get the canvas and context, as well as 
		// -- attach some listeners.
		// -- @return void
		/* ------------------------------------------- */
		
		init: function(){
			globals.canvas = $('#board');
			globals.context = globals.canvas[0].getContext("2d");
			globals.context.background = defaults.background;
			globals.context.font = defaults.font;
			
			containers.flags = $('#flags'); 
			containers.mines = $('#mines');
			containers.status = $('#status');
			containers.time = $('#time');
			containers.msg = $('#msg');
			
			containers.easy = $('#easybtn');
			containers.medium = $('#mediumbtn');
			containers.insane = $('#insanebtn');
			
			var difarr = { 9: containers.easy, 6: containers.medium, 3: containers.insane};
			
			$.each(difarr, function(index, value){
				value.live({
					click: function(){
						defaults.difficulty = index;
						util.switchScreens();
					}
				});
			});
			
			$('.gamescreen').hide();
			
			// Attach some listeners, at this point only mousedown
			globals.canvas.live({
				'mousedown': function(e){
					action.click(e);
				}	
			});
			
			// Initialize the board
			core.setup();
		},
		
		/* ------------------------------------------- */
		// -- Reset function
		// -- Resets the game, clears the timers, etc.
		// -- @return void
		/* ------------------------------------------- */
		
		reset: function(){	
			
			// Clear the timer
			window.clearInterval(globals.clock);
			window.clearInterval(globals.restart);
		
			// Wipe the canvas clean
			globals.context.clearRect(0,0,400,400);
			
			// Reset all global vars to their default value
			globals.gameover = false;
			globals.firstClick = true;
			globals.totalMines = 0;
			globals.totalFlags = 0;
			globals.elapsedTime = 0;
			globals.mineMap = new Array(20);
			globals.flagMap = new Array(20);
			globals.revealedMap = new Array(20);
			
			// Clear certain containers
			containers.flags.html('');
			containers.mines.html('');
			containers.status.html('Game on :)');
			containers.time.html('0');
			containers.msg.html('Click on a square to start the game!');
			
			// Initialize the board
			core.setup();
			
			//util.switchScreens();
		},
		
		/* ------------------------------------------- */
		// -- Setup function
		// -- Sets up certain variables and draws the 
		// -- board. Used during both init() and reset()
		// -- @return void
		/* ------------------------------------------- */
		
		setup: function(){
			// Clear flagMap array
			for(var k = 0; k < 20; k++){
				globals.flagMap[k] = Array(20);
				globals.revealedMap[k] = Array(20);
			}
			
			// Make sure proper styles are set
			globals.context.strokeStyle = defaults.celStroke;
			globals.context.fillStyle = defaults.celColor;
			
			// Draw all the rounded squares
			for(var i = 0; i <= defaults.width; i = i + 20){
				for(var j = 0; j <= defaults.height; j = j + 20){
					util.roundRect(i, j, defaults.celSize - 1, defaults.celSize - 1);
				} 
			}
		},
		
		/* ------------------------------------------- */
		// -- Timer function
		// -- Starts the clock
		// -- @return void
		/* ------------------------------------------- */
		
		timer: function(){
			// Setup global var timer
			globals.clock = setInterval(function(){
				globals.elapsedTime++;
				// Append time to #time
				containers.time.html(globals.elapsedTime);
			}, 1000)	
		}
	};
	
	/* =========================================== */
	// --- Action Functions ---
	/* =========================================== */
	
	var action = {
		
		/* ------------------------------------------- */
		// -- Click function
		// -- listens to right and left mouse clicks
		// -- and determines the proper cel and what 
		// -- action to take.
		// -- @return void
		/* ------------------------------------------- */
		
		click: function(e){
			
			// Calculate x & y relevant to the cel size, also (l) check if current x,y combo has already been revealed
			var x = Math.floor((e.pageX - globals.canvas[0].offsetLeft - 1) / defaults.celSize),
				y = Math.floor((e.pageY - globals.canvas[0].offsetTop - 1) / defaults.celSize),
				l = (globals.revealedMap[x][y]) ? 1 : -1;
			
			// If left-click, not a flag and the game is still going on
			if(e.which == 1 && globals.flagMap[x][y] != 1 && !globals.gameover && defaults.difficulty !== 0){
				
				// Is this the first click of the game?
				if(globals.firstClick === true){
					
					// Set difficulty, based on default and difficulty selector, and start the timer
					//defaults.difficulty = containers.difficulty.val();
					core.timer();
					
					// Keep generating possible minemaps till one is generate where the square first clicked is not a mine
					do
						action.generateMines(globals.mineMap);
					while(globals.mineMap[x][y] == -1);
					
					// Set number of mines
					containers.mines.html('You have to find ' + globals.totalMines + ' mines to win.');
					globals.firstClick = false;
				}
				
				// Activate index function. See below for more details
				action.index(x, y);
			
			// If right-click, game is not over, square has not been revealed and this is not the first click	
			}else if(e.which == 3 && !globals.gameover && l < 0 && globals.firstClick !== true){
				
				// Flag the square
				var flag = new Image();
				flag.src = defaults.flagImg;
				flag.onload = function(){
					action.flag(flag,x,y);
				};
			}	
		},
		
		/* ------------------------------------------- */
		// -- Hover function
		// -- Speaks for itself
		// -- @return void
		/* ------------------------------------------- */
		
		hover: function(e){
			
			// TODO Some fancy hover stuff
			
		},
		
		/* ------------------------------------------- */
		// -- Index function
		// -- Used to determine whether square is a mine
		// -- or not 
		// -- @return void
		/* ------------------------------------------- */
		
		index: function(x, y){
			
			// If square is not revealed, is within boundaries and exists
			if(x >= 0 && y >= 0 && x <= 20 && y <= 20 && globals.mineMap[x] != undefined){
				
				var l = (globals.revealedMap[x][y]) ? 1 : -1;
				
				if(l < 0){
				
					// 'remove square', by drawing a white one over it
					globals.context.fillStyle = 'white';
					globals.context.strokeStyle = 'white';
					util.roundRect(x * 20, y * 20, defaults.celSize, defaults.celSize);
					
					// Add revealed square to the revealed array
					globals.revealedMap[x][y] = 1;
					
					// If the square that was clicked has no surrounding mines...
					if(globals.mineMap[x][y] === 0){
						
						// remove all neighbors till squares are found that do have surrounding mines
						for(var i = -1; i <= 1; i++){
							for(var j = -1; j <= 1; j++){
								// If a neighboring square is also not surrounded by mines, remove his neighbors also; and repeat
								if(l < 0 && x + i >= 0 && y + j >= 0 && x + i <= 20 && y + j <= 20){
									action.index(x + i, y + j);
								}
							}
						}
						
					// If the square does not cover a mine, display the index number
					}else if(globals.mineMap[x][y] != -1){
						
						// Default colors for the index numbers in an array. [0] not having a color.
						var colorMap = ['none', 'blue', 'green', 'red', 'black', 'orange', 'cyan'];
						globals.context.fillStyle = colorMap[globals.mineMap[x][y]];
						globals.context.fillText(globals.mineMap[x][y], (x * 20) + 5, (y * 20) + 16);
						
					}else{
						
						// If unforutantely there is mine, display it and trigger the function leading to the end of the game
						var mine = new Image();
						mine.src = defaults.mineImg;
						mine.onload = function() {
							action.revealMines(mine);
						};
					}
				}
			}
		},
		
		/* ------------------------------------------- */
		// -- Flag function
		// -- Used to flag a square
		// -- @return void
		/* ------------------------------------------- */
		
		flag: function(flag, x, y){
			
			// If square is not already flagged
			if(globals.flagMap[x][y] != 1){
				
				// Draw flag
				globals.context.drawImage(flag, x * 20, y * 20, 20, 20);
				globals.flagMap[x][y] = 1;
				globals.totalFlags++;
				
			}else{
				
				// Remove flag image
				var img = globals.context.createImageData(20, 20);
				for(var i = img.data.length; --i >= 0;){
				  img.data[i] = 0;
				}
				
				globals.context.putImageData(img, x * 20, y * 20);
				
				// Make sure proper styles are set
				globals.context.strokeStyle = defaults.celStroke;
				globals.context.fillStyle = defaults.celColor;
			
				util.roundRect(x * 20, y * 20, defaults.celSize - 1, defaults.celSize - 1);
					
				globals.flagMap[x][y] = 0;
				globals.totalFlags--;
			}
			
			// Adjust counters accordingly
			containers.mines.html('You have to find ' + (globals.totalMines - globals.totalFlags) + ' mines to win.');
			containers.flags.html('You have set ' + globals.totalFlags + ' flags.');
			
			// With every flag (or unflag) check if the game has been won
			action.won();
		},
		
		/* ------------------------------------------- */
		// -- Won function
		// -- Used to determine if the game has been won
		// -- @return void
		/* ------------------------------------------- */
		
		won: function(){
			
			// Setup counter
			var count = 0;
			
			// Count the number of flagged mines 
			for(var i = 0; i < 20; i++){
				for(var j = 0; j < 20; j++){
					if((globals.flagMap[i][j] == 1 ) && (globals.mineMap[i][j] == -1)){
						count++;
					} 
				}
			}
			
			// If the number of flagged mines equals the total number of mines, the game has been won
			if(count === globals.totalMines){
				// Set game over status
				globals.gameover = true;
				containers.status.html('You won! :D');
				
				// Stops the timer and counts down to a reset of the game
				window.clearInterval(globals.clock);
				globals.restart = setTimeout("core.reset();",3000);
			}
		},
		
		/* ------------------------------------------- */
		// -- Generate Mines function
		// -- Places the mines on the field, at random
		// -- @return void
		/* ------------------------------------------- */
		
		generateMines: function(){
			
			// For every square
			for(var i = 0; i < 20; i++){
				globals.mineMap[i] = new Array(20);
				
				// The lower the dificulty, the more mines
				for(var j = 0; j < 20; j++){
					globals.mineMap[i][j] = Math.floor((Math.random() * defaults.difficulty) - 1);
					
					if(globals.mineMap[i][j] > 0){
						globals.mineMap[i][j] = 0;
					}
				}
			} 
			
			// Move on to the next step of the setup
			action.calculateMines();
		},
		
		/* ------------------------------------------- */
		// -- Calculate Mines function
		// -- Used to calculate surrounding mines number
		// -- @return void
		/* ------------------------------------------- */
		
		calculateMines: function() {
			
			var mineCount = 0;
			globals.totalMines = 0;
			
			// Check every square
			for(var i = 0; i < 20; i++){
				for(var j = 0; j < 20; j++){
					
					//If the square is not a mine; calculate its surround mine number
					if(globals.mineMap[i][j] != -1){
						//N
						if(j > 0 && globals.mineMap[i][j-1] == -1){
							mineCount++;
						}
						//NW
						if(i > 0 && j > 0 && globals.mineMap[i-1][j-1] == -1){
							mineCount++;
						}
						//NE
						if(j > 0 && i < 19 && globals.mineMap[i+1][j-1] == -1){
							mineCount++;
						}
						//E
						if(i < 19 && globals.mineMap[i+1][j] == -1){
							mineCount++;
						}
						//W
						if(i > 0 && globals.mineMap[i-1][j] == -1){
							mineCount++;
						}
						//S
						if(j < 19 && globals.mineMap[i][j+1] == -1){
							mineCount++;
						}
						//SW
						if(i > 0 && j < 19 && globals.mineMap[i-1][j+1] == -1 ){
							mineCount++;
						}
						//SE
						if(i < 19 && j < 19 && globals.mineMap[i+1][j+1]){
							mineCount++;
						} 
						
						// Save number and reset the counter
						globals.mineMap[i][j] = mineCount;
						mineCount = 0;
						
					} else {
						
						// Count the mines
						globals.totalMines++;		
					}
				} 
			}
		},
		
		/* ------------------------------------------- */
		// -- Reveal Mines function
		// -- Reveals all the mines and triggers a game
		// -- over status
		// -- @return void
		/* ------------------------------------------- */
		
		revealMines: function(mine){
			
			// Draw all the mines
			for(var i = 0; i < 20; i++){
				for(var j = 0; j < 20; j++){
					if(globals.mineMap[i][j] == -1)
						globals.context.drawImage(mine, i * 20, j * 20, 20, 20);
				}
			}
			
			// Set game over status
			globals.gameover = true;
			containers.status.html('Game over :(');
			containers.msg.html('A new game will start in 3 seconds.');
			
			// Stops the timer and counts down to a reset of the game
			window.clearInterval(globals.clock);
			globals.restart = setTimeout("core.reset();",3000);
		}
	};
	
	/* =========================================== */
	// --- Utility Functions ---
	/* =========================================== */
	
	var util = {
		
		/* ------------------------------------------- */
		// -- Rounded Rectangle function
		// -- Draws rounded rectangles
		/* ------------------------------------------- */
		
		roundRect: function(x, y, width, height){
			globals.context.beginPath();
			globals.context.moveTo(x + defaults.celRadius, y);
			globals.context.lineTo(x + width - defaults.celRadius, y);
			globals.context.quadraticCurveTo(x + width, y, x + width, y + defaults.celRadius);
			globals.context.lineTo(x + width, y + height - defaults.celRadius);
			globals.context.quadraticCurveTo(x + width, y + height, x + width - defaults.celRadius, y + height);
			globals.context.lineTo(x + defaults.celRadius, y + height);
			globals.context.quadraticCurveTo(x, y + height, x, y + height - defaults.celRadius);
			globals.context.lineTo(x, y + defaults.celRadius);
			globals.context.quadraticCurveTo(x, y, x + defaults.celRadius, y);
			globals.context.closePath();
			globals.context.stroke();
			globals.context.fill();    
		},
		
		switchScreens: function(){
			if($('.startscreen').is(':hidden') == false){
				$('.startscreen').fadeToggle(400, 'swing', function(){
					core.reset();
					$('.gamescreen').fadeToggle();
				});		
			}else{
				$('.gamescreen').fadeToggle(400, 'swing', function(){
					core.reset();
					defaults.difficulty = 0;
					$('.startscreen').fadeToggle();
				});		
			}
		}
	};
	
	/* =========================================== */
	// --- Initiate Minesweeper ---
	/* =========================================== */
	
	$(function(){
		core.init();
	});
	
	</script>
</head>

<body>
	<div class="container">
		<header class="row">
			<div class="sixcol">
			<h1>HTML5 Minesweeper</h1>
			</div>
			<div class="sixcol last">
				
			</div>
		</header>
		<section class="row">
			<div class="sixcol">
				<canvas id="board" width="400" height="400" oncontextmenu="return false;">
					<p>Unfortunately, your browser does not seem to support the canvas element.</p>
				</canvas>
			
				<noscript>
					<p>Unfortunately, your javascript is disabled. You will need to enable it in order to play the game.</p>
				</noscript>
			</div>
			<div class="sixcol last">
				<div class="startscreen">
					<h1>Start Game</h1>
					<p>Please choose a difficulty to get started.</p>
					<button id="easybtn">Easy</button>
					<button id="mediumbtn">Medium</button>
					<button id="insanebtn">Insane</button>
				</div>
				
				<div class="gamescreen">
					<h1 id="status">Game on :)</h1>
					<p id="msg">Click on a square to start the game!</p>
					<button onclick="core.reset();">Reset</button>
					<button onclick="util.switchScreens();">Change Difficulty</button>
					<br>
					<p><span id="time">0</span> seconds have passed</p>
					<span id="mines"></span>
					<span id="flags"></span>
				</div>
				
				<a href="http://www.w3.org/html/logo/">
					<img src="http://www.w3.org/html/logo/badge/html5-badge-h-css3-graphics.png" width="165" height="64" alt="HTML5 Powered with CSS3 / Styling, and Graphics, 3D &amp; Effects" title="HTML5 Powered with CSS3 / Styling, and Graphics, 3D &amp; Effects">
				</a>
			</div>
		</section>
	</div>
</body>
</html>